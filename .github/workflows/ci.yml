name: CI - Build, QA & Security

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci:
    name: CI Validation
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # 1. Checkout source code
      # ------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------------
      # 2. Secret Scanning
      # ------------------------------------
      - name: Secret Scan - Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scanners: secret
          exit-code: 1

      # ------------------------------------
      # 3. Build & start app (Docker Compose)
      # ------------------------------------
      - name: Build and start services
        run: docker compose up -d --build

      # ------------------------------------
      # 4. Build Validation
      # ------------------------------------
      - name: Verify containers
        run: docker compose ps

      # ------------------------------------
      # 5. QA - Syntax / Lint Check
      # ------------------------------------
      - name: QA - PHP syntax check
        run: docker compose exec -T dvwa php -l index.php

      # ------------------------------------
      # 6. QA - Unit Testing (Expandable)
      # ------------------------------------
      - name: QA - Unit Tests (Placeholder)
        run: |
          echo "Add PHPUnit tests here"
          # docker compose exec -T dvwa vendor/bin/phpunit

      # ------------------------------------
      # 7. SAST - Static Code Analysis
      # ------------------------------------
      - name: SAST - Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      # ------------------------------------
      # 8. SCA + Misconfiguration Scan
      # ------------------------------------
      - name: SCA & Misconfig Scan - Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          exit-code: 1

      # ------------------------------------
      # 9. Cleanup
      # ------------------------------------
      - name: Stop services
        run: docker compose down
