name: CI - QA, Security & Build Validation

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci:
    name: CI Full Validation
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1. Checkout Source Code
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. Secret Scanning (Whole Repo)
      # --------------------------------------------------
      - name: Secret Scan - Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          fail: true

      # --------------------------------------------------
      # 3. SCA - Dependency & License Scan (Whole Repo)
      # --------------------------------------------------
      - name: SCA - Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scanners: vuln,license
          severity: HIGH,CRITICAL
          exit-code: 1

      # --------------------------------------------------
      # 4. Build Images (Docker Compose)
      # --------------------------------------------------
      - name: Build application (Docker Compose)
        run: docker compose build

      # --------------------------------------------------
      # 5. Start Application for QA Checks
      # --------------------------------------------------
      - name: Start application
        run: docker compose up -d

      # --------------------------------------------------
      # 6. QA - Syntax / Lint Checks (Whole Repo)
      # --------------------------------------------------
      - name: QA - PHP Syntax Check
        run: |
          docker compose exec -T dvwa bash -c \
          "find . -name '*.php' -exec php -l {} \;"

      # --------------------------------------------------
      # 7. QA - Unit Tests (Expandable)
      # --------------------------------------------------
      - name: QA - Unit Tests
        run: |
          echo "Unit tests placeholder"
          # docker compose exec -T dvwa vendor/bin/phpunit

      # --------------------------------------------------
      # 8. SAST - Static Code Analysis (Whole Repo)
      # --------------------------------------------------
      - name: SAST - Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      # --------------------------------------------------
      # 9. Image Security Scan
      # --------------------------------------------------
      - name: Image Scan - Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: dvwa
          severity: HIGH,CRITICAL
          exit-code: 1

      # --------------------------------------------------
      # 10. Cleanup
      # --------------------------------------------------
      - name: Cleanup containers
        run: docker compose down
