name: GitGuardian Secret Scan (SARIF)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  secret-scan:
    name: GitGuardian Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GitGuardian CLI
        run: pip install ggshield

      - name: Run GitGuardian secret scan (JSON â€“ temp)
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        run: |
          ggshield secret scan repo . --json > gg.json || true

      - name: Convert GitGuardian JSON to SARIF
        run: |
          python - << 'EOF'
          import json

          with open("gg.json") as f:
              data = json.load(f)

          sarif = {
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "GitGuardian",
                          "informationUri": "https://www.gitguardian.com",
                          "rules": []
                      }
                  },
                  "results": []
              }]
          }

          for scan in data.get("scans", []):
              for entity in scan.get("entities_with_incidents", []):
                  for incident in entity.get("incidents", []):
                      sarif["runs"][0]["results"].append({
                          "ruleId": incident["type"],
                          "level": "error",
                          "message": {
                              "text": incident["type"]
                          },
                          "locations": [{
                              "physicalLocation": {
                                  "artifactLocation": {
                                      "uri": entity["filename"]
                                  }
                              }
                          }]
                      })

          with open("gitguardian.sarif", "w") as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Upload GitGuardian SARIF report
        uses: actions/upload-artifact@v4
        with:
          name: gitguardian-sarif-report
          path: gitguardian.sarif
